<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Psychiatric Training Session</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .chat-scroll::-webkit-scrollbar { width: 8px; }
        .chat-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .chat-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .chat-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden font-sans text-gray-800 relative">

    <script>
        const API_BASE_URL = ""; 
    </script>

    <!-- LOADING OVERLAY -->
    <div id="loading-overlay" class="hidden absolute inset-0 bg-white/80 z-50 flex flex-col justify-center items-center backdrop-blur-sm">
        <div class="loader mb-4"></div>
        <p id="loading-text" class="text-xl font-semibold text-gray-700">Loading...</p>
    </div>

    <!-- PAGE 1: LANDING -->
    <div id="landing-page" class="flex h-full">
        
        <!-- Left: Start New -->
        <div class="w-1/2 bg-white flex flex-col justify-center items-center border-r border-gray-200 p-10">
            <div class="max-w-md w-full">
                <h2 class="text-3xl font-bold mb-6 text-blue-600">Start New Session</h2>
                <div class="space-y-3 mb-8">
                    <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-blue-50 transition">
                        <input type="radio" name="disorder" value="MDD" class="w-5 h-5 text-blue-600" checked>
                        <div class="ml-3">
                            <span class="block font-semibold">MDD</span>
                            <span class="text-sm text-gray-500">Major Depressive Disorder</span>
                        </div>
                    </label>
                    <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-blue-50 transition">
                        <input type="radio" name="disorder" value="GAD" class="w-5 h-5 text-blue-600">
                        <div class="ml-3">
                            <span class="block font-semibold">GAD</span>
                            <span class="text-sm text-gray-500">Generalized Anxiety Disorder</span>
                        </div>
                    </label>
                    <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-blue-50 transition">
                        <input type="radio" name="disorder" value="PPD" class="w-5 h-5 text-blue-600">
                        <div class="ml-3">
                            <span class="block font-semibold">PPD</span>
                            <span class="text-sm text-gray-500">Paranoid Personality Disorder</span>
                        </div>
                    </label>
                </div>
                <button onclick="startSession()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
                    Start Simulation
                </button>
            </div>
        </div>

        <!-- Right: Saved Sessions (Cards) -->
        <div class="w-1/2 bg-gray-50 flex flex-col p-10">
            <div class="max-w-xl w-full mx-auto flex flex-col h-full">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-700">Saved Sessions</h2>
                    <button onclick="loadSessionList()" class="text-blue-600 hover:underline text-sm">Refresh</button>
                </div>
                <div id="session-list" class="flex-1 overflow-y-auto space-y-3 pr-2 chat-scroll">
                    <!-- Cards injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- PAGE 2: SESSION -->
    <div id="session-page" class="hidden h-full flex">
        <!-- Chat Area -->
        <div class="w-3/5 flex flex-col border-r border-gray-300 bg-white">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <div>
                    <h1 class="font-bold text-lg">Current Session</h1>
                    <span class="text-xs text-gray-500" id="display-uuid">ID: --</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="endSession()" class="text-sm bg-red-50 text-red-600 px-3 py-1 rounded border border-red-200 hover:bg-red-100">Save & Exit</button>
                    <button onclick="downloadTranscript()" class="text-sm bg-green-50 text-green-700 px-3 py-1 rounded border border-green-200 hover:bg-green-100">Download</button>
                </div>
            </div>
            <div id="chat-box" class="flex-1 overflow-y-auto p-6 space-y-4 chat-scroll bg-slate-50"></div>
            <div class="p-4 border-t bg-white">
                <form onsubmit="sendMessage(event)" class="flex gap-2">
                    <input type="text" id="message-input" class="flex-1 border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Type message..." autocomplete="off">
                    <button type="submit" id="send-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">Send</button>
                </form>
            </div>
        </div>

        <!-- Tools Area -->
        <div class="w-2/5 flex flex-col bg-white">
            <div class="h-1/2 border-b border-gray-200 flex flex-col">
                <div class="bg-gray-100 p-3 border-b font-semibold text-gray-700">Patient Intake Form</div>
                <div class="p-6 overflow-y-auto">
                    <div id="intake-display" class="space-y-3 text-sm"></div>
                </div>
            </div>
            <div class="h-1/2 flex flex-col bg-yellow-50">
                <div class="bg-yellow-100 p-3 border-b border-yellow-200 font-semibold text-yellow-800">Interviewer Notes</div>
                <textarea class="flex-1 w-full p-4 bg-yellow-50 resize-none focus:outline-none text-gray-700 font-mono text-sm"></textarea>
            </div>
        </div>
    </div>

    <script>
        let currentSessionId = null;

        // Initialize
        window.onload = function() {
            loadSessionList();
        }

        function toggleLoading(show, text="Loading...") {
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading-overlay').classList.toggle('hidden', !show);
        }

        // --- Session List Logic ---
        async function loadSessionList() {
        const container = document.getElementById('session-list');
        container.innerHTML = '<p class="text-center text-gray-400 mt-10">Loading saved sessions...</p>';
        
        try {
            const res = await fetch(API_BASE_URL + '/api/sessions');
            if (!res.ok) throw new Error("Failed to load list");
            const sessions = await res.json();
            
            if (sessions.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 mt-10">No saved sessions yet.</p>';
                return;
            }

            container.innerHTML = sessions.map(s => `
                <div class="group bg-white p-4 rounded-lg border border-gray-200 hover:border-blue-400 shadow-sm hover:shadow-md transition relative">
                    <!-- Clickable Area for Resume -->
                    <div onclick="resumeSession('${s.session_id}')" class="cursor-pointer">
                        <div class="flex justify-between">
                            <h3 class="font-bold text-gray-800">${s.patient_name || 'Unknown'}</h3>
                            <span class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-600">${s.turns} turns</span>
                        </div>
                        <p class="text-xs text-blue-600 font-medium uppercase mt-1">${s.disorder || 'N/A'}</p>
                        <p class="text-xs text-gray-400 mt-2 font-mono">ID: ${s.session_id.substring(0,8)}...</p>
                    </div>

                    <!-- Delete Button (Top Right, visible on hover) -->
                    <button onclick="deleteSession('${s.session_id}')" class="absolute top-2 right-2 p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded opacity-0 group-hover:opacity-100 transition" title="Delete Session">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
            `).join('');
            
        } catch (err) {
            container.innerHTML = `<p class="text-center text-red-400 mt-10">Error: ${err.message}</p>`;
        }
    }

    // Add this new function
    async function deleteSession(id) {
        if(!confirm("Are you sure you want to delete this session? This cannot be undone.")) return;

        try {
            const res = await fetch(`${API_BASE_URL}/api/delete/${id}`, {
                method: 'DELETE'
            });
            
            if (res.ok) {
                loadSessionList(); // Refresh the list
            } else {
                alert("Failed to delete session");
            }
        } catch (err) {
            alert("Error: " + err.message);
        }
    }

        // --- Actions ---
        async function startSession() {
            const disorder = document.querySelector('input[name="disorder"]:checked').value;
            toggleLoading(true, "Creating Profile...");
            
            try {
                const res = await fetch(API_BASE_URL + '/api/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({disorder})
                });
                if (!res.ok) throw new Error("Start failed");
                const data = await res.json();
                
                setupSessionUI(data.session_id, data.patient_data);
                document.getElementById('chat-box').innerHTML = `
                    <div class="flex justify-start"><div class="bg-white border border-gray-200 text-gray-800 rounded-lg rounded-tl-none py-2 px-4 shadow-sm max-w-[80%]">
                        <p class="text-sm">System: Session initialized. Begin interview.</p>
                    </div></div>`;
                
                loadSessionList(); // Refresh list in background
            } catch (err) {
                alert(err.message);
            } finally {
                toggleLoading(false);
            }
        }

        async function resumeSession(id) {
    toggleLoading(true, "Restoring Session...");
    try {
        const res = await fetch(API_BASE_URL + '/api/load', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({session_id: id})
        });
        if (!res.ok) throw new Error("Load failed");
        const data = await res.json();
        
        setupSessionUI(data.session_id, data.patient_data);
        
        // Restore Notes
        document.querySelector('textarea').value = data.interviewer_notes || "";
        
        // Restore Chat History
        const chatBox = document.getElementById('chat-box');
        chatBox.innerHTML = ''; // Clear existing
        
        if (data.chat_history && data.chat_history.length > 0) {
            data.chat_history.forEach(msg => {
                appendMessage(msg.role, msg.text);
            });
            // Add marker
            const marker = document.createElement('div');
            marker.className = "flex justify-center my-4";
            marker.innerHTML = '<span class="text-xs bg-blue-50 text-blue-600 px-3 py-1 rounded-full border border-blue-100">Session Resumed</span>';
            chatBox.appendChild(marker);
        } else {
             chatBox.innerHTML = `<div class="flex justify-start"><div class="bg-white border border-gray-200 text-gray-800 rounded-lg rounded-tl-none py-2 px-4 shadow-sm max-w-[80%]"><p class="text-sm">System: Session resumed. No previous chat history found.</p></div></div>`;
        }
        
    } catch (err) {
        alert(err.message);
    } finally {
        toggleLoading(false);
    }
}


        async function sendMessage(e) {
            e.preventDefault();
            const input = document.getElementById('message-input');
            const msg = input.value.trim();
            if (!msg || !currentSessionId) return;
            
            appendMessage('Interviewer', msg);
            input.value = '';
            document.getElementById('send-btn').disabled = true;
            
            // Typing indicator
            const chatId = document.getElementById('chat-box');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'flex justify-start';
            typingDiv.innerHTML = `<div class="bg-white border border-gray-200 rounded-lg rounded-tl-none py-3 px-4 shadow-sm"><div class="flex space-x-1"><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div></div></div>`;
            chatId.appendChild(typingDiv);
            chatId.scrollTop = chatId.scrollHeight;

            try {
                const res = await fetch(API_BASE_URL + '/api/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({session_id: currentSessionId, message: msg})
                });
                if (!res.ok) throw new Error("Chat error");
                const text = await res.json();
                
                typingDiv.remove();
                appendMessage('Patient', text);
            } catch (err) {
                typingDiv.remove();
                appendMessage('System', "Error: " + err.message);
            } finally {
                document.getElementById('send-btn').disabled = false;
            }
        }

        // --- Helpers ---
        function setupSessionUI(id, patientData) {
            currentSessionId = id;
            document.getElementById('display-uuid').textContent = 'ID: ' + id;
            document.getElementById('landing-page').classList.add('hidden');
            document.getElementById('session-page').classList.remove('hidden');
            document.getElementById('session-page').classList.add('flex');
            
            const intake = document.getElementById('intake-display');
            if (patientData && typeof patientData === 'object') {
                intake.innerHTML = Object.entries(patientData).map(([k,v]) => `
                    <div class="flex border-b border-gray-100 py-2">
                        <span class="font-bold text-gray-600 w-1/3 text-xs uppercase tracking-wide">${k}:</span>
                        <span class="text-gray-800 w-2/3 text-sm">${v}</span>
                    </div>`).join('');
            } else {
                intake.innerHTML = '<p class="text-gray-400 italic">No data available</p>';
            }
        }

        function appendMessage(role, text) {
            const div = document.createElement('div');
            div.className = `flex ${role === 'Interviewer' ? 'justify-end' : 'justify-start'}`;
            const isMe = role === 'Interviewer';
            div.innerHTML = `
                <div class="${isMe ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-white border border-gray-200 text-gray-800 rounded-tl-none'} rounded-lg py-2 px-4 max-w-[80%] shadow-sm">
                    <div class="text-xs ${isMe ? 'text-blue-100' : 'text-gray-400'} mb-1 font-bold uppercase">${role}</div>
                    <p class="text-sm whitespace-pre-wrap">${text}</p>
                </div>`;
            const box = document.getElementById('chat-box');
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        async function endSession() {
    if(!currentSessionId) return;
    
    const notes = document.querySelector('textarea').value;
    
    // Auto-save notes
    try {
        await fetch(API_BASE_URL + '/api/save_notes', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                session_id: currentSessionId,
                notes: notes
            })
        });
    } catch(e) {
        console.error("Failed to save notes on exit", e);
    }

    if(confirm("Exit session? Notes have been saved.")) {
        currentSessionId = null;
        document.getElementById('session-page').classList.add('hidden');
        document.getElementById('landing-page').classList.remove('hidden');
        loadSessionList();
    }
}

        async function downloadTranscript() {
    if (!currentSessionId) {
        alert("No active session to download.");
        return;
    }

    try {
        // 1. Request the file from the backend
        const response = await fetch(`${API_BASE_URL}/api/file`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'ngrok-skip-browser-warning': 'true' // Helpful if using ngrok
             },
            // The backend expects a ChatRequest model, so we send the session_id
            body: JSON.stringify({ session_id: currentSessionId, message: "" }) 
        });

        if (!response.ok) {
            throw new Error("Failed to generate transcript");
        }

        // 2. Get the file content as a Blob
        const blob = await response.blob();
        
        // 3. Create a download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        
        // Set filename (using session ID ensures it's unique)
        a.download = `session-${currentSessionId.substring(0, 8)}.txt`;
        
        // 4. Trigger download and cleanup
        document.body.appendChild(a); // Required for Firefox
        a.click();
        
        // Cleanup
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

    } catch (err) {
        console.error(err);
        alert("Download failed: " + err.message);
    }
}
    </script>
</body>
</html>
